@using System.Security.Claims
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model APP_LAWYER.DAL.Entities.Subcategory

@{
    ViewBag.Title = Model.Name;
    Layout = "_Layout";
}

<div class="container">
    <h2>@Model.Name</h2>
    @if (Model.SubcategoryVideos != null)
    {
        <h3>Videos:</h3>
        <div id="videoContainer" class="mb-3">
            @for (int i = 0; i < Model.SubcategoryVideos.Count; i++)
            {
                var subcategoryVideo = Model.SubcategoryVideos[i];
                <div class="video" style="display: @(i == 0 ? "block" : "none")" data-description="@subcategoryVideo.Video.Description">
                    <div class="embed-responsive embed-responsive-16by9">
                        <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/@(subcategoryVideo.Video.Url.Split('/').Last())" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                </div>
            }
            <button id="nextVideo" class="btn btn-primary">Next Video</button>
        </div>
    }

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="description-tab" data-bs-toggle="tab" href="#description" role="tab" aria-controls="description" aria-selected="true">Описание дела</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="content-tab" data-bs-toggle="tab" href="#content" role="tab" aria-controls="content" aria-selected="false">Юридическое заключение и законодательство</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="video-description-tab" data-bs-toggle="tab" href="#video-description" role="tab" aria-controls="video-description" aria-selected="false">Образец документа</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="comments-tab" data-bs-toggle="tab" href="#comments" role="tab" aria-controls="comments" aria-selected="false">Комментарий</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
            <p>@Model.Description</p>
        </div>
        <div class="tab-pane fade" id="content" role="tabpanel" aria-labelledby="content-tab">
            <p>@Model.Content</p>
        </div>
        <div class="tab-pane fade" id="video-description" role="tabpanel" aria-labelledby="video-description-tab">
            <p id="videoDescription"></p>
        </div>
        <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
            <div class="container">
                <!-- Add comment form -->
                <h4>Оставьте комментарий:</h4>
                <form id="createCommentForm" method="post" action="/Comment/Create">
                    <div class="form-group">
                        <label for="commentContent">Комментарий:</label>
                        <textarea class="form-control" id="commentContent" name="Content" rows="3"></textarea>
                    </div>
                    <input type="hidden" name="SubcategoryId" value="@Model.Id"/>
                    <button type="submit" class="btn btn-primary">Отправить</button>
                </form>
                <!-- Existing comments -->
                <!-- Existing comments -->
                <h3>Comments:</h3>
                <div id="commentContainer">
                    @if (Model.Comments != null)
                    {
                        foreach (var comment in Model.Comments)
                        {
                            <div class="comment">
                                <p>@comment.Content</p>
                                @if (comment.User != null)
                                {
                                    <p>By: @comment.User.FirstName</p>
                                }
                                else
                                {
                                    <p>No user associated with this comment.</p>
                                }

                                <!-- Replies to the comment -->
                                <div class="replies">
                                    @if (comment.Replies != null)
                                    {
                                        foreach (var reply in comment.Replies)
                                        {
                                            <div class="reply">
                                                <p>@reply.Text</p>
                                                @if (reply.User != null)
                                                {
                                                    <p>By: @reply.User.FirstName</p>
                                                }
                                                else
                                                {
                                                    <p>No user associated with this reply.</p>
                                                }
                                            </div>
                                        }
                                    }
                                </div>

                                <!-- Add reply form -->
                                <form class="createReplyForm" method="post" action="/Reply/Create">
                                    <div class="form-group">
                                        <label for="replyText">Reply:</label>
                                        <textarea class="form-control" id="replyText" name="Text" rows="2"></textarea>
                                    </div>
                                    <input type="hidden" name="CommentId" value="@comment.Id"/>
                                    <button type="submit" class="btn btn-primary">Reply</button>
                                </form>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            var currentVideoIndex = 0;
            var videos = $("#videoContainer .video");

            function updateVideoDescription() {
                var description = $(videos[currentVideoIndex]).data("description");
                $("#videoDescription").text(description);
            }

            $("#nextVideo").click(function () {
                $(videos[currentVideoIndex]).hide();
                currentVideoIndex++;
                if (currentVideoIndex >= videos.length) {
                    currentVideoIndex = 0;
                }
                $(videos[currentVideoIndex]).show();
                updateVideoDescription();
            });

            updateVideoDescription();
            var subcategoryId = $('[name="SubcategoryId"]').val();
                $.get("/Subcategory/Comments/" + subcategoryId, function(data) {
                    $("#commentContainer").html(data);
                });
            // Code for comment form
            $("#createCommentForm").on('submit', function (event) {
                event.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr("action"),
                    method: form.attr("method"),
                    data: form.serialize(),
                    success: function () {
                        // Reload comments
                        $.get("/Subcategory/Comments/" + form.find('[name="SubcategoryId"]').val(), function(data) {
                            $("#commentContainer").html(data);
                        });
                    },
                    error: function () {
                        alert('Error! Could not submit form.');
                    }
                });
            });
            $(".createReplyForm").on('submit', function (event) {
                event.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr("action"),
                    method: form.attr("method"),
                    data: form.serialize(),
                    success: function () {
                        // Reload comments
                        $.get("/Subcategory/Comments/" + subcategoryId, function(data) {
                            $("#commentContainer").html(data);
                        });
                    },
                    error: function () {
                        alert('Error! Could not submit form.');
                    }
                });
            });
        });
    </script>
}